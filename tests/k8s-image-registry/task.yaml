summary: Test K8s image registry configuration with a local authenticated mirror

systems:
  - ubuntu-24.04

environment:
  REGISTRY_USERNAME: testuser
  REGISTRY_PASSWORD: testpass

execute: |
  pushd "${SPREAD_PATH}/${SPREAD_TASK}"

  # Install htpasswd utility for generating auth credentials
  apt-get update -qq
  apt-get install -y -qq apache2-utils

  # Download and install Zot registry (minimal OCI-native registry with auth and mirroring support)
  ARCH=$(dpkg --print-architecture)
  ZOT_VERSION="v2.1.14"
  curl -fsSL "https://github.com/project-zot/zot/releases/download/${ZOT_VERSION}/zot-linux-${ARCH}-minimal" -o /usr/local/bin/zot
  chmod +x /usr/local/bin/zot

  # Set up Zot configuration
  mkdir -p /etc/zot /var/lib/zot
  htpasswd -Bbn "${REGISTRY_USERNAME}" "${REGISTRY_PASSWORD}" > /etc/zot/htpasswd

  cat > /etc/zot/config.json << 'ZOTCFG'
  {
    "distSpecVersion": "1.1.0",
    "storage": {
      "rootDirectory": "/var/lib/zot"
    },
    "http": {
      "address": "0.0.0.0",
      "port": "5000",
      "auth": {
        "htpasswd": {
          "path": "/etc/zot/htpasswd"
        }
      }
    },
    "extensions": {
      "sync": {
        "registries": [
          {
            "urls": ["https://registry-1.docker.io"],
            "onDemand": true,
            "content": [
              {
                "prefix": "**"
              }
            ]
          }
        ]
      }
    }
  }
  ZOTCFG

  # Start Zot in the background
  zot serve /etc/zot/config.json &

  # Wait for Zot to be ready
  for i in $(seq 1 30); do
    if curl -sf -u "${REGISTRY_USERNAME}:${REGISTRY_PASSWORD}" http://localhost:5000/v2/ > /dev/null 2>&1; then
      break
    fi
    sleep 1
  done

  # Verify Zot requires authentication (unauthenticated request should fail)
  if curl -sf http://localhost:5000/v2/ > /dev/null 2>&1; then
    echo "ERROR: Registry should require authentication but didn't"
    exit 1
  fi

  # Run concierge to prepare K8s with the registry mirror
  "$SPREAD_PATH"/concierge --trace prepare

  # Verify the hosts.toml was created with the correct content
  test -f /etc/containerd/hosts.d/docker.io/hosts.toml
  cat /etc/containerd/hosts.d/docker.io/hosts.toml
  grep -q 'server = "http://localhost:5000"' /etc/containerd/hosts.d/docker.io/hosts.toml
  grep -q 'capabilities = \["pull", "resolve"\]' /etc/containerd/hosts.d/docker.io/hosts.toml
  grep -q 'authorization = "Basic' /etc/containerd/hosts.d/docker.io/hosts.toml

  # Verify k8s is running
  sudo k8s status --wait-ready

  # Pull an image through the authenticated mirror
  sudo /snap/k8s/current/bin/ctr --address /run/containerd/containerd.sock --namespace k8s.io images pull docker.io/library/busybox:latest

  # Verify the mirror was actually used by checking Zot's catalog for the cached image
  curl -sf -u "${REGISTRY_USERNAME}:${REGISTRY_PASSWORD}" http://localhost:5000/v2/_catalog | grep -q busybox

  # Stop Zot so spread doesn't wait for the background process
  kill $(pgrep -f "zot serve") 2>/dev/null || true
  wait 2>/dev/null || true

restore: |
  kill $(pgrep -f "zot serve") 2>/dev/null || true
  if [[ -z "${CI:-}" ]]; then
    "$SPREAD_PATH"/concierge --trace restore
  fi
