summary: Run concierge with extra bootstrap arguments
systems:
  - ubuntu-24.04

execute: |
  pushd "${SPREAD_PATH}/${SPREAD_TASK}"

  "$SPREAD_PATH"/concierge --trace prepare

  juju controllers | tail -n1 | MATCH concierge-microk8s
  juju models | tail -n1 | MATCH testing

  # Verify the controller config was set
  juju controller-config | grep idle-connection-timeout | tr -s " " | MATCH "idle-connection-timeout: 90s"

restore: |
  if [[ -z "${CI:-}" ]]; then
    "$SPREAD_PATH"/concierge --trace restore
  fi
